<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effluent Flow Recorder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body.dark-mode {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
        }
        body.dark-mode .bg-white {
            background-color: #1e293b !important;
            color: #e2e8f0;
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .alert-banner {
            animation: slideDown 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-100 min-h-screen p-4">

    <!-- Alert Container -->
    <div id="alertContainer" class="fixed top-0 left-0 right-0 z-50"></div>

    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-2">
                    üíß Effluent Flow Recorder Pro
                </h1>
                <p class="text-blue-100 mt-1">Professional Water Quality Monitoring System</p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleDarkMode()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                    <span id="darkModeIcon">üåô</span>
                </button>
                <button onclick="exportCSV()" class="px-4 py-2 bg-green-500 rounded-lg hover:bg-green-600">
                    üì• Export CSV
                </button>
                <button onclick="backupData()" class="px-4 py-2 bg-yellow-500 rounded-lg hover:bg-yellow-600">
                    üíæ Backup
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Records</h3>
            <p id="totalRecords" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Today's Records</h3>
            <p id="todayRecords" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Volume</h3>
            <p id="totalFlow" class="text-3xl font-bold text-purple-600">0 m¬≥</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Average pH</h3>
            <p id="avgPH" class="text-3xl font-bold text-indigo-600">‚Äî</p>
        </div>
    </div>

    <!-- Input Form -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">
            <span id="formTitle">üìù New Reading Entry</span>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <!-- Date -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                <input type="date" id="inputDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Time -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Time *</label>
                <input type="time" id="inputTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Type -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Effluent Type *</label>
                <select id="inputType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select Type</option>
                    <option value="Raw Effluent">Raw Effluent</option>
                    <option value="Treated Effluent">Treated Effluent</option>
                    <option value="Industrial Wastewater">Industrial Wastewater</option>
                    <option value="Domestic Sewage">Domestic Sewage</option>
                    <option value="Cooling Water">Cooling Water</option>
                    <option value="Process Water">Process Water</option>
                    <option value="Stormwater Runoff">Stormwater Runoff</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <!-- pH -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">pH Value</label>
                <input type="number" id="inputPH" step="0.1" min="0" max="14" placeholder="0.0 - 14.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Temperature -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temperature (¬∞C)</label>
                <input type="number" id="inputTemp" step="0.1" placeholder="e.g., 25.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Volume -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Volume (m¬≥)</label>
                <input type="number" id="inputVolume" step="0.01" min="0" placeholder="e.g., 100.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Flow Rate -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Flow Rate (m¬≥/hr)</label>
                <input type="number" id="inputFlowRate" step="0.01" min="0" placeholder="e.g., 10.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Location -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" id="inputLocation" placeholder="e.g., Outlet 1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Operator -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Operator Name *</label>
                <input type="text" id="inputOperator" required placeholder="Your name" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg bg-blue-50">
            </div>
        </div>

        <!-- Remarks -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Remarks / Notes</label>
            <textarea id="inputRemarks" rows="2" placeholder="Any observations..." class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>

        <!-- Buttons -->
        <div class="flex gap-3">
            <button type="button" id="saveBtn" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                ‚úÖ Save Record
            </button>
            <button type="button" id="cancelBtn" style="display: none;" class="px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition">
                Cancel
            </button>
            <button type="button" onclick="clearForm()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition">
                üóëÔ∏è Clear
            </button>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">üîç Search & Filter</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" id="searchBox" placeholder="Search records..." class="px-3 py-2 border border-gray-300 rounded-lg" onkeyup="applyFilters()">
            <select id="filterOperator" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                <option value="">All Operators</option>
            </select>
            <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="Raw Effluent">Raw Effluent</option>
                <option value="Treated Effluent">Treated Effluent</option>
                <option value="Industrial Wastewater">Industrial Wastewater</option>
                <option value="Domestic Sewage">Domestic Sewage</option>
                <option value="Cooling Water">Cooling Water</option>
                <option value="Process Water">Process Water</option>
                <option value="Stormwater Runoff">Stormwater Runoff</option>
                <option value="Other">Other</option>
            </select>
            <input type="date" id="filterDate" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
        </div>
        <div class="mt-3">
            <button type="button" onclick="clearFilters()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                Clear Filters
            </button>
        </div>
    </div>

    <!-- Records Table -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">üìä Records List</h3>
        <div class="overflow-x-auto">
            <table class="w-full" id="recordsTable">
                <thead class="bg-blue-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left">Date</th>
                        <th class="px-4 py-3 text-left">Time</th>
                        <th class="px-4 py-3 text-left">Type</th>
                        <th class="px-4 py-3 text-left">pH</th>
                        <th class="px-4 py-3 text-left">Temp (¬∞C)</th>
                        <th class="px-4 py-3 text-left">Volume (m¬≥)</th>
                        <th class="px-4 py-3 text-left">Flow (m¬≥/hr)</th>
                        <th class="px-4 py-3 text-left">Operator</th>
                        <th class="px-4 py-3 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsBody" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">No records yet. Add your first record above!</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">üìà Analytics Charts</h3>
        <div id="chartsContainer">
            <p class="text-center text-gray-500 py-8">No data available for charts yet</p>
        </div>
    </div>

    <!-- Restore Data -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">‚öôÔ∏è Data Management</h3>
        <input type="file" id="restoreFile" accept=".json" style="display:none">
        <button type="button" onclick="document.getElementById('restoreFile').click()" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
            üìÇ Restore from Backup
        </button>
        <button type="button" onclick="deleteAllData()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 ml-2">
            üóëÔ∏è Delete All Data
        </button>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        var records = [];
        var filteredRecords = [];
        var editingId = null;
        var charts = {};

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            setCurrentDateTime();
            updateStats();
            renderRecords();
            updateOperatorFilter();
            
            // Setup event listeners
            document.getElementById('saveBtn').addEventListener('click', saveRecord);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            document.getElementById('restoreFile').addEventListener('change', restoreData);
            
            // Dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        });

        // ========== DATA MANAGEMENT ==========
        function loadRecords() {
            var stored = localStorage.getItem('effluentRecords');
            if (stored) {
                try {
                    records = JSON.parse(stored);
                } catch (e) {
                    records = [];
                }
            }
        }

        function saveRecords() {
            localStorage.setItem('effluentRecords', JSON.stringify(records));
        }

        // ========== DATE/TIME HELPERS ==========
        function setCurrentDateTime() {
            var now = new Date();
            var date = now.toISOString().split('T')[0];
            var time = now.toTimeString().slice(0, 5);
            document.getElementById('inputDate').value = date;
            document.getElementById('inputTime').value = time;
        }

        // ========== ALERTS ==========
        function showAlert(message, type) {
            var container = document.getElementById('alertContainer');
            var colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            var alert = document.createElement('div');
            alert.className = 'alert-banner ' + colors[type] + ' text-white px-6 py-4 shadow-lg flex items-center justify-between mb-2 mx-4 mt-2 rounded-lg';
            alert.innerHTML = '<span><strong>' + message + '</strong></span>' +
                            '<button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 text-xl ml-4">&times;</button>';
            
            container.appendChild(alert);
            setTimeout(function() { alert.remove(); }, 4000);
        }

        // ========== SAVE RECORD ==========
        function saveRecord() {
            var date = document.getElementById('inputDate').value;
            var time = document.getElementById('inputTime').value;
            var type = document.getElementById('inputType').value;
            var operator = document.getElementById('inputOperator').value.trim();

            // Validation
            if (!date || !time) {
                showAlert('‚ö†Ô∏è Please enter date and time', 'error');
                return;
            }

            if (!type) {
                showAlert('‚ö†Ô∏è Please select effluent type', 'error');
                return;
            }

            if (!operator) {
                showAlert('‚ö†Ô∏è Operator name is required!', 'error');
                document.getElementById('inputOperator').focus();
                return;
            }

            // Create record object
            var record = {
                id: editingId || Date.now(),
                date: date,
                time: time,
                type: type,
                ph: document.getElementById('inputPH').value ? parseFloat(document.getElementById('inputPH').value) : null,
                temperature: document.getElementById('inputTemp').value ? parseFloat(document.getElementById('inputTemp').value) : null,
                volume: document.getElementById('inputVolume').value ? parseFloat(document.getElementById('inputVolume').value) : null,
                flowRate: document.getElementById('inputFlowRate').value ? parseFloat(document.getElementById('inputFlowRate').value) : null,
                location: document.getElementById('inputLocation').value,
                operator: operator,
                remarks: document.getElementById('inputRemarks').value
            };

            // Save or update
            if (editingId) {
                var index = records.findIndex(function(r) { return r.id === editingId; });
                records[index] = record;
                showAlert('‚úÖ Record updated successfully!', 'success');
                editingId = null;
            } else {
                records.push(record);
                showAlert('‚úÖ Record saved for ' + operator + '!', 'success');
            }

            saveRecords();
            clearForm();
            updateStats();
            applyFilters();
            updateOperatorFilter();
            updateCharts();
        }

        // ========== EDIT RECORD ==========
        function editRecord(id) {
            var record = records.find(function(r) { return r.id === id; });
            if (!record) return;

            document.getElementById('inputDate').value = record.date;
            document.getElementById('inputTime').value = record.time;
            document.getElementById('inputType').value = record.type;
            document.getElementById('inputPH').value = record.ph || '';
            document.getElementById('inputTemp').value = record.temperature || '';
            document.getElementById('inputVolume').value = record.volume || '';
            document.getElementById('inputFlowRate').value = record.flowRate || '';
            document.getElementById('inputLocation').value = record.location;
            document.getElementById('inputOperator').value = record.operator;
            document.getElementById('inputRemarks').value = record.remarks || '';

            editingId = id;
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Edit Reading Entry';
            document.getElementById('saveBtn').textContent = 'üíæ Update Record';
            document.getElementById('cancelBtn').style.display = 'block';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== DELETE RECORD ==========
        function deleteRecord(id) {
            if (!confirm('Delete this record?')) return;
            
            records = records.filter(function(r) { return r.id !== id; });
            saveRecords();
            updateStats();
            applyFilters();
            updateOperatorFilter();
            updateCharts();
            showAlert('üóëÔ∏è Record deleted', 'success');
        }

        // ========== CANCEL EDIT ==========
        function cancelEdit() {
            editingId = null;
            clearForm();
        }

        // ========== CLEAR FORM ==========
        function clearForm() {
            document.getElementById('inputType').value = '';
            document.getElementById('inputPH').value = '';
            document.getElementById('inputTemp').value = '';
            document.getElementById('inputVolume').value = '';
            document.getElementById('inputFlowRate').value = '';
            document.getElementById('inputLocation').value = '';
            document.getElementById('inputOperator').value = '';
            document.getElementById('inputRemarks').value = '';
            document.getElementById('formTitle').textContent = 'üìù New Reading Entry';
            document.getElementById('saveBtn').textContent = '‚úÖ Save Record';
            document.getElementById('cancelBtn').style.display = 'none';
            editingId = null;
            setCurrentDateTime();
        }

        // ========== RENDER RECORDS ==========
        function renderRecords() {
            var tbody = document.getElementById('recordsBody');
            var dataToShow = filteredRecords.length > 0 ? filteredRecords : records;
            
            if (dataToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">No records found</td></tr>';
                return;
            }

            var html = '';
            var sortedRecords = dataToShow.slice().sort(function(a, b) {
                var dateA = new Date(a.date + ' ' + a.time);
                var dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA;
            });

            sortedRecords.forEach(function(record) {
                html += '<tr class="hover:bg-blue-50">' +
                    '<td class="px-4 py-3">' + record.date + '</td>' +
                    '<td class="px-4 py-3">' + record.time + '</td>' +
                    '<td class="px-4 py-3">' + record.type + '</td>' +
                    '<td class="px-4 py-3">' + (record.ph !== null ? record.ph : '‚Äî') + '</td>' +
                    '<td class="px-4 py-3">' + (record.temperature !== null ? record.temperature : '‚Äî') + '</td>' +
                    '<td class="px-4 py-3">' + (record.volume !== null ? record.volume.toFixed(2) : '‚Äî') + '</td>' +
                    '<td class="px-4 py-3">' + (record.flowRate !== null ? record.flowRate.toFixed(2) : '‚Äî') + '</td>' +
                    '<td class="px-4 py-3">' + record.operator + '</td>' +
                    '<td class="px-4 py-3">' +
                        '<button onclick="editRecord(' + record.id + ')" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 mr-1">Edit</button>' +
                        '<button onclick="deleteRecord(' + record.id + ')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Del</button>' +
                    '</td>' +
                '</tr>';
            });

            tbody.innerHTML = html;
        }

        // ========== UPDATE STATS ==========
        function updateStats() {
            var today = new Date().toISOString().split('T')[0];
            var todayRecords = records.filter(function(r) { return r.date === today; });
            
            document.getElementById('totalRecords').textContent = records.length;
            document.getElementById('todayRecords').textContent = todayRecords.length;
            
            var totalFlow = records.reduce(function(sum, r) { return sum + (r.volume || 0); }, 0);
            document.getElementById('totalFlow').textContent = totalFlow.toFixed(2) + ' m¬≥';
            
            var phValues = records.filter(function(r) { return r.ph !== null; }).map(function(r) { return r.ph; });
            if (phValues.length > 0) {
                var avgPH = phValues.reduce(function(a, b) { return a + b; }, 0) / phValues.length;
                document.getElementById('avgPH').textContent = avgPH.toFixed(1);
            } else {
                document.getElementById('avgPH').textContent = '‚Äî';
            }
        }

        // ========== FILTERS ==========
        function applyFilters() {
            var searchText = document.getElementById('searchBox').value.toLowerCase();
            var operatorFilter = document.getElementById('filterOperator').value;
            var typeFilter = document.getElementById('filterType').value;
            var dateFilter = document.getElementById('filterDate').value;

            filteredRecords = records.filter(function(record) {
                var match = true;
                
                if (searchText) {
                    var searchable = (record.date + ' ' + record.time + ' ' + record.type + ' ' + 
                                    record.operator + ' ' + record.location + ' ' + record.remarks).toLowerCase();
                    if (searchable.indexOf(searchText) === -1) match = false;
                }
                
                if (operatorFilter && record.operator !== operatorFilter) match = false;
                if (typeFilter && record.type !== typeFilter) match = false;
                if (dateFilter && record.date !== dateFilter) match = false;
                
                return match;
            });

            renderRecords();
            updateCharts();
        }

        function clearFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterOperator').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterDate').value = '';
            filteredRecords = [];
            renderRecords();
            updateCharts();
        }

        function updateOperatorFilter() {
            var operators = [];
            records.forEach(function(r) {
                if (r.operator && operators.indexOf(r.operator) === -1) {
                    operators.push(r.operator);
                }
            });
            
            var select = document.getElementById('filterOperator');
            var currentValue = select.value;
            select.innerHTML = '<option value="">All Operators</option>';
            operators.sort().forEach(function(op) {
                select.innerHTML += '<option value="' + op + '">' + op + '</option>';
            });
            if (operators.indexOf(currentValue) !== -1) {
                select.value = currentValue;
            }
        }

        // ========== CHARTS ==========
        function updateCharts() {
            var container = document.getElementById('chartsContainer');
            var dataToShow = filteredRecords.length > 0 ? filteredRecords : records;
            
            // Destroy existing charts
            Object.values(charts).forEach(function(chart) { chart.destroy(); });
            charts = {};

            if (dataToShow.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No data available for charts</p>';
                return;
            }

            // Sort by date and time
            var sortedData = dataToShow.slice().sort(function(a, b) {
                return new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time);
            });

            var labels = sortedData.map(function(r) { return r.date + ' ' + r.time; });
            var phData = sortedData.map(function(r) { return r.ph; });
            var tempData = sortedData.map(function(r) { return r.temperature; });
            var flowData = sortedData.map(function(r) { return r.flowRate; });

            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6">' +
                '<div><h4 class="text-center font-semibold mb-2 text-blue-600">pH Level</h4><div class="chart-container"><canvas id="phChart"></canvas></div></div>' +
                '<div><h4 class="text-center font-semibold mb-2 text-red-600">Temperature (¬∞C)</h4><div class="chart-container"><canvas id="tempChart"></canvas></div></div>' +
                '<div><h4 class="text-center font-semibold mb-2 text-purple-600">Flow Rate (m¬≥/hr)</h4><div class="chart-container"><canvas id="flowChart"></canvas></div></div>' +
                '</div>';

            // pH Chart
            charts.ph = new Chart(document.getElementById('phChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pH Level',
                        data: phData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 0, max: 14 }
                    }
                }
            });

            // Temperature Chart
            charts.temp = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: tempData,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Flow Rate Chart
            charts.flow = new Chart(document.getElementById('flowChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Flow Rate (m¬≥/hr)',
                        data: flowData,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ========== EXPORT CSV ==========
        function exportCSV() {
            if (records.length === 0) {
                showAlert('No records to export', 'info');
                return;
            }

            var csv = 'Date,Time,Type,pH,Temperature (¬∞C),Volume (m¬≥),Flow Rate (m¬≥/hr),Location,Operator,Remarks\n';
            records.forEach(function(r) {
                csv += r.date + ',' +
                       r.time + ',' +
                       '"' + r.type + '",' +
                       (r.ph !== null ? r.ph : '') + ',' +
                       (r.temperature !== null ? r.temperature : '') + ',' +
                       (r.volume !== null ? r.volume : '') + ',' +
                       (r.flowRate !== null ? r.flowRate : '') + ',' +
                       '"' + r.location + '",' +
                       '"' + r.operator + '",' +
                       '"' + (r.remarks || '') + '"\n';
            });

            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Effluent_Records_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('‚úÖ Exported ' + records.length + ' records to CSV', 'success');
        }

        // ========== BACKUP ==========
        function backupData() {
            var backup = {
                records: records,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            var blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Effluent_Backup_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('‚úÖ Backup downloaded successfully!', 'success');
        }

        // ========== RESTORE ==========
        function restoreData(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var backup = JSON.parse(e.target.result);
                    
                    if (confirm('Restore ' + backup.records.length + ' records? This will overwrite current data!')) {
                        records = backup.records || [];
                        saveRecords();
                        updateStats();
                        renderRecords();
                        updateOperatorFilter();
                        updateCharts();
                        showAlert('‚úÖ Data restored successfully!', 'success');
                    }
                } catch (err) {
                    showAlert('‚ùå Invalid backup file!', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // ========== DELETE ALL ==========
        function deleteAllData() {
            if (!confirm('‚ö†Ô∏è DELETE ALL DATA? This cannot be undone!')) return;
            if (!confirm('Are you ABSOLUTELY SURE? All records will be permanently deleted!')) return;
            
            records = [];
            filteredRecords = [];
            saveRecords();
            updateStats();
            renderRecords();
            updateOperatorFilter();
            updateCharts();
            showAlert('üóëÔ∏è All data deleted', 'info');
        }

        // ========== DARK MODE ==========
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            var isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
    </script>

</body>
</html>
