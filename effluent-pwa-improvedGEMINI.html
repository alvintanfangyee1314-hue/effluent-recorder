<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effluent Flow Recorder PRO v4 - ENHANCED (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body.dark-mode {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
        }
        body.dark-mode .bg-white {
            background-color: #1e293b !important;
            color: #e2e8f0;
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .text-gray-700 {
            color: #e2e8f0 !important;
        }
        body.dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .alert-banner {
            animation: slideDown 0.5s ease-out;
        }
        .warning-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-normal { background-color: #d1fae5; color: #065f46; }
        .status-warning { background-color: #fef3c7; color: #92400e; }
        .status-critical { background-color: #fee2e2; color: #991b1b; }
        
        body.dark-mode .status-normal { background-color: #064e3b; color: #d1fae5; }
        body.dark-mode .status-warning { background-color: #78350f; color: #fef3c7; }
        body.dark-mode .status-critical { background-color: #7f1d1d; color: #fee2e2; }
        @media print {
            body { background: white; padding: 20px; }
            .no-print { display: none !important; }
            .bg-white { background: white !important; border: 1px solid #ddd; }
            table { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-100 min-h-screen p-4">

    <div id="alertContainer" class="fixed top-0 left-0 right-0 z-50"></div>

    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-2">
                    üíß Effluent Flow Recorder Pro
                </h1>
                <p class="text-blue-100 mt-1">Professional Water Quality Monitoring System - v4 PRO Edition (Final)</p>
            </div>
            <div class="flex gap-2 flex-wrap">
                <button onclick="toggleDarkMode()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                    <span id="darkModeIcon">üåô</span>
                </button>
                
                <button onclick="exportPDF()" class="px-4 py-2 bg-red-500 rounded-lg hover:bg-red-600">
                    üìÑ Export PDF
                </button>
                <button onclick="exportExcel()" class="px-4 py-2 bg-emerald-500 rounded-lg hover:bg-emerald-600">
                    üìä Export Excel
                </button>
                <button onclick="document.getElementById('importFile').click()" class="px-4 py-2 bg-blue-500 rounded-lg hover:bg-blue-600">
                    üì• Import Data
                </button>
                <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="importData(event)">
                <button onclick="backupData()" class="px-4 py-2 bg-yellow-500 rounded-lg hover:bg-yellow-600">
                    üíæ Backup
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            ‚öôÔ∏è Compliance Standards & Thresholds
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">pH Standard</label>
                <select id="phStandard" onchange="saveSettings(); updateAll();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="A">Standard A (6.0 - 9.0)</option>
                    <option value="B">Standard B (5.5 - 9.0) - Lenient</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Max Temperature (¬∞C)</label>
                <input type="number" id="tempThreshold" value="40" step="0.1" onchange="saveSettings(); updateAll();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Min Flow Rate (m¬≥/hr)</label>
                <input type="number" id="flowRateMin" value="0" step="0.1" onchange="saveSettings(); updateAll();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Max Flow Rate (m¬≥/hr)</label>
                <input type="number" id="flowRateMax" value="100" step="0.1" onchange="saveSettings(); updateAll();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div class="flex items-center pt-5">
                <input type="checkbox" id="enforceComplianceData" onchange="saveSettings(); updateAll();" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2">
                <label for="enforceComplianceData" class="text-sm font-medium text-gray-700">Enforce Compliance Data</label>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
            <h3 class="font-semibold text-sm text-gray-700 mb-2">üìã Current Standards:</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-2 text-sm">
                <div>
                    <span class="font-medium">pH Range:</span> 
                    <span id="phRangeDisplay">6.0 - 9.0</span>
                </div>
                <div>
                    <span class="font-medium">Temperature:</span> 
                    <span>‚â§ <span id="tempThresholdDisplay">40</span>¬∞C</span>
                </div>
                <div>
                    <span class="font-medium">Flow Rate:</span> 
                    <span id="flowRateRangeDisplay">0 - 100 m¬≥/hr</span>
                </div>
                 <div>
                    <span class="font-medium">Data Enforcement:</span> 
                    <span id="enforcementStatus">Disabled</span>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Records</h3>
            <p id="totalRecords" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Today's Records</h3>
            <p id="todayRecords" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Volume</h3>
            <p id="totalFlow" class="text-3xl font-bold text-purple-600">0 m¬≥</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Average pH</h3>
            <p id="avgPH" class="text-3xl font-bold text-indigo-600">‚Äî</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">‚ö†Ô∏è Alerts</h3>
            <p id="alertCount" class="text-3xl font-bold text-red-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Avg Flow Rate</h3>
            <p id="avgFlowRate" class="text-3xl font-bold text-cyan-600">‚Äî</p>
        </div>
    </div>


    <div id="analyticsPanel" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">üìä Advanced Analytics</h3>
            <button onclick="toggleAnalytics()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm">
                <span id="analyticsToggle">Show Details</span>
            </button>
        </div>
        <div id="analyticsContent" style="display: none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="border rounded-lg p-4">
                    <h4 class="font-semibold text-sm text-gray-700 mb-3">pH Statistics</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Minimum:</span>
                            <span id="phMin" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Maximum:</span>
                            <span id="phMax" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Median:</span>
                            <span id="phMedian" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Std Dev:</span>
                            <span id="phStdDev" class="font-semibold">‚Äî</span>
                        </div>
                    </div>
                </div>
                
                <div class="border rounded-lg p-4">
                    <h4 class="font-semibold text-sm text-gray-700 mb-3">Temperature Statistics</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Minimum:</span>
                            <span id="tempMin" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Maximum:</span>
                            <span id="tempMax" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Median:</span>
                            <span id="tempMedian" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Std Dev:</span>
                            <span id="tempStdDev" class="font-semibold">‚Äî</span>
                        </div>
                    </div>
                </div>
                
                <div class="border rounded-lg p-4">
                    <h4 class="font-semibold text-sm text-gray-700 mb-3">Flow Rate Statistics</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Minimum:</span>
                            <span id="flowMin" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Maximum:</span>
                            <span id="flowMax" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Median:</span>
                            <span id="flowMedian" class="font-semibold">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Std Dev:</span>
                            <span id="flowStdDev" class="font-semibold">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">
            <span id="formTitle">üìù New Reading Entry</span>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                <input type="date" id="inputDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Time *</label>
                <input type="time" id="inputTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Effluent Type *</label>
                <select id="inputType" required onchange="toggleOtherType()" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select Type</option>
                    <option value="Raw Effluent">Raw Effluent</option>
                    <option value="Treated Effluent">Treated Effluent</option>
                    <option value="Industrial Wastewater">Industrial Wastewater</option>
                    <option value="Domestic Sewage">Domestic Sewage</option>
                    <option value="Cooling Water">Cooling Water</option>
                    <option value="Process Water">Process Water</option>
                    <option value="Stormwater Runoff">Stormwater Runoff</option>
                    <option value="Other">Other (Specify below)</option>
                </select>
            </div>

            <div id="customTypeContainer" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 mb-1">Specify Effluent Type *</label>
                <input type="text" id="inputCustomType" placeholder="Enter effluent type name..." class="w-full px-3 py-2 border-2 border-orange-400 rounded-lg bg-orange-50">
                <p class="text-xs text-gray-500 mt-1">Required when "Other" is selected</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"><span id="phLabel">pH Value</span></label>
                <input type="number" id="inputPH" step="0.1" min="0" max="14" placeholder="0.0 - 14.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">Valid range: 0.0 - 14.0</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"><span id="tempLabel">Temperature (¬∞C)</span></label>
                <input type="number" id="inputTemp" step="0.1" placeholder="e.g., 25.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Volume (m¬≥)</label>
                <input type="number" id="inputVolume" step="0.01" min="0" placeholder="e.g., 100.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div class="md:col-span-1 flex items-center pt-1">
                <input type="checkbox" id="autoCalculateFlow" onchange="toggleFlowInputMode()" class="h-4 w-4 text-purple-600 border-gray-300 rounded mr-2">
                <label for="autoCalculateFlow" class="text-sm font-medium text-gray-700">Auto-calculate Flow Rate</label>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"><span id="flowRateLabel">Flow Rate (m¬≥/hr)</span></label>
                <input type="number" id="inputFlowRate" step="0.01" min="0" placeholder="e.g., 10.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" id="inputLocation" placeholder="e.g., Outlet 1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Operator Name *</label>
                <input type="text" id="inputOperator" required placeholder="Your name" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg bg-blue-50">
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Remarks / Notes</label>
            <textarea id="inputRemarks" rows="2" placeholder="Any observations..." class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>

        <div class="flex gap-3">
            <button type="button" id="saveBtn" onclick="saveRecord()" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                ‚úÖ Save Record
            </button>
            <button type="button" id="cancelBtn" style="display: none;" onclick="cancelEdit()" class="px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition">
                Cancel
            </button>
            <button type="button" onclick="clearForm()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition">
                üóëÔ∏è Clear
            </button>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">üîç Search & Advanced Filters</h3>
        
        <div class="flex flex-wrap gap-2 mb-4">
            <button onclick="applyQuickFilter('today')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                Today
            </button>
            <button onclick="applyQuickFilter('yesterday')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                Yesterday
            </button>
            <button onclick="applyQuickFilter('last7days')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                Last 7 Days
            </button>
            <button onclick="applyQuickFilter('thisMonth')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                This Month
            </button>
            <button onclick="applyQuickFilter('lastMonth')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                Last Month
            </button>
            <button onclick="applyQuickFilter('all')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium">
                Show All
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" id="searchBox" placeholder="Search records..." class="px-3 py-2 border border-gray-300 rounded-lg" onkeyup="applyFilters()">
            
            <div>
                <label class="block text-xs text-gray-600 mb-1">From Date</label>
                <input type="date" id="filterDateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
            </div>
            
            <div>
                <label class="block text-xs text-gray-600 mb-1">To Date</label>
                <input type="date" id="filterDateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
            </div>
            
            <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                <option value="">All Types</option>
            </select>
            
            <select id="filterOperator" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                <option value="">All Operators</option>
            </select>
            
            <select id="filterStatus" class="px-3 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="normal">‚úÖ Normal</option>
                <option value="warning">‚ö†Ô∏è Warning</option>
                <option value="critical">üî¥ Critical</option>
            </select>
            
            <button onclick="clearFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                Clear Filters
            </button>
        </div>
        
        <div class="mt-3 text-sm text-gray-600">
            Showing <span id="recordCount" class="font-semibold">0</span> of <span id="totalCount" class="font-semibold">0</span> records
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 overflow-x-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">üìä Records</h3>
            <div class="flex gap-2">
                <label class="flex items-center gap-2 text-sm">
                    <input type="file" id="restoreFile" onchange="restoreData(event)" accept=".json" class="hidden">
                    <button onclick="document.getElementById('restoreFile').click()" class="px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm">
                        üì§ Restore Backup
                    </button>
                </label>
                <button onclick="deleteAllData()" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">
                    üóëÔ∏è Delete All
                </button>
            </div>
        </div>

        <table id="recordsTable" class="w-full text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left">Status</th>
                    <th class="px-4 py-3 text-left">Date</th>
                    <th class="px-4 py-3 text-left">Time</th>
                    <th class="px-4 py-3 text-left">Type</th>
                    <th class="px-4 py-3 text-left">pH</th>
                    <th class="px-4 py-3 text-left">Temp (¬∞C)</th>
                    <th class="px-4 py-3 text-left">Volume (m¬≥)</th>
                    <th class="px-4 py-3 text-left">Flow Rate</th>
                    <th class="px-4 py-3 text-left">Location</th>
                    <th class="px-4 py-3 text-left">Operator</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                    <th class="px-4 py-3 text-left">History</th>
                </tr>
            </thead>
            <tbody id="recordsBody">
                <tr>
                    <td colspan="12" class="text-center py-8 text-gray-400">No records found</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="chartsSection" class="bg-white rounded-lg shadow-lg p-6 mb-6" style="display: none;">
        <h3 class="text-lg font-semibold mb-4">üìà Analytics Charts</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="chart-container"><canvas id="statusPieChart"></canvas></div>
            <div class="chart-container"><canvas id="phHistogramChart"></canvas></div>
        </div>
        <div id="chartsContainer"></div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        var records = [];
        var filteredRecords = [];
        var editingId = null;
        var charts = {};

        // Settings
        var settings = {
            phStandard: 'A',
            tempThreshold: 40,
            flowRateMin: 0,
            flowRateMax: 100,
            enforceComplianceData: false
        };

        // ========== INITIALIZATION ==========
        window.onload = function() {
            try {
                loadSettings();
                loadRecords();
                
                // üü¢ REVISED: Load Persistent Form Data (Operator/Location)
                var lastOperator = localStorage.getItem('lastOperator');
                var lastLocation = localStorage.getItem('lastLocation');

                if (lastOperator) document.getElementById('inputOperator').value = lastOperator;
                if (lastLocation) document.getElementById('inputLocation').value = lastLocation;
                // üü¢ END REVISED

                updateAll(); // Consolidated update function
                
                var today = new Date().toISOString().split('T')[0];
                document.getElementById('inputDate').value = today;
                
                var now = new Date();
                var hours = String(now.getHours()).padStart(2, '0');
                var minutes = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('inputTime').value = hours + ':' + minutes;
                
                // üü¢ NEW: Initialize Flow Input Mode
                toggleFlowInputMode();

                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('‚ùå Critical error during startup. Check console.', 'error');
            }
        };

        function updateAll() {
            try {
                updateStandardsDisplay();
                updateFormEnforcement();
                updateOperatorFilter();
                updateTypeFilter();
                updateStats();
                updateAdvancedAnalytics();
                renderRecords();
                updateCharts();
                applyFilters(); // Re-apply filters to refresh data visualization
            } catch (error) {
                console.error('Error in updateAll:', error);
            }
        }

        // ========== TOGGLE OTHER TYPE ==========
        function toggleOtherType() {
            try {
                var typeSelect = document.getElementById('inputType');
                var customTypeContainer = document.getElementById('customTypeContainer');
                var customTypeInput = document.getElementById('inputCustomType');
                
                if (typeSelect.value === 'Other') {
                    customTypeContainer.style.display = 'block';
                    customTypeInput.required = true;
                } else {
                    customTypeContainer.style.display = 'none';
                    customTypeInput.required = false;
                    customTypeInput.value = '';
                }
            } catch (error) {
                console.error('Error toggling other type:', error);
            }
        }

        // ========== NEW: TOGGLE FLOW INPUT MODE ==========
        function toggleFlowInputMode() {
            var isAuto = document.getElementById('autoCalculateFlow').checked;
            var flowInput = document.getElementById('inputFlowRate');
            var flowLabel = document.getElementById('flowRateLabel');

            if (isAuto) {
                flowInput.setAttribute('readonly', 'true');
                flowInput.classList.add('bg-gray-100');
                flowInput.placeholder = 'Auto-calculated on save';
                flowLabel.textContent = 'Flow Rate (m¬≥/hr) (Auto)';
                // If it's required by compliance, we still show the *
                if (settings.enforceComplianceData) {
                    flowLabel.innerHTML = 'Flow Rate (m¬≥/hr) (Auto)' + ' *';
                }
                flowInput.value = ''; // Clear manual entry
            } else {
                flowInput.removeAttribute('readonly');
                flowInput.classList.remove('bg-gray-100');
                flowInput.placeholder = 'e.g., 10.5';
                flowLabel.textContent = 'Flow Rate (m¬≥/hr)';
                // Restore label based on enforcement setting
                updateFormEnforcement();
            }
        }

        // ========== SETTINGS MANAGEMENT ==========
        function loadSettings() {
            var saved = localStorage.getItem('effluentSettings');
            if (saved) {
                try {
                    var loadedSettings = JSON.parse(saved);
                    // Merge loaded settings with defaults to handle new keys (like enforceComplianceData)
                    settings = Object.assign(settings, loadedSettings);

                    document.getElementById('phStandard').value = settings.phStandard || 'A';
                    document.getElementById('tempThreshold').value = settings.tempThreshold || 40;
                    document.getElementById('flowRateMin').value = settings.flowRateMin || 0;
                    document.getElementById('flowRateMax').value = settings.flowRateMax || 100;
                    document.getElementById('enforceComplianceData').checked = settings.enforceComplianceData || false;
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }

        function saveSettings() {
            settings = {
                phStandard: document.getElementById('phStandard').value,
                tempThreshold: parseFloat(document.getElementById('tempThreshold').value) || 40,
                flowRateMin: parseFloat(document.getElementById('flowRateMin').value) || 0,
                flowRateMax: parseFloat(document.getElementById('flowRateMax').value) || 100,
                enforceComplianceData: document.getElementById('enforceComplianceData').checked
            };
            localStorage.setItem('effluentSettings', JSON.stringify(settings));
            updateStandardsDisplay();
            updateFormEnforcement();
        }

        function updateStandardsDisplay() {
            try {
                var phStandard = document.getElementById('phStandard').value;
                var phRange = phStandard === 'A' ? '6.0 - 9.0' : '5.5 - 9.0';
                document.getElementById('phRangeDisplay').textContent = phRange;
                document.getElementById('tempThresholdDisplay').textContent = document.getElementById('tempThreshold').value;
                
                var flowMin = document.getElementById('flowRateMin').value;
                var flowMax = document.getElementById('flowRateMax').value;
                document.getElementById('flowRateRangeDisplay').textContent = flowMin + ' - ' + flowMax + ' m¬≥/hr';

                var enforcement = settings.enforceComplianceData ? 'Enabled (Mandatory PH/Temp/Flow)' : 'Disabled';
                document.getElementById('enforcementStatus').textContent = enforcement;
            } catch (error) {
                console.error('Error updating standards display:', error);
            }
        }

        function updateFormEnforcement() {
            try {
                var isRequired = settings.enforceComplianceData;
                var phInput = document.getElementById('inputPH');
                var tempInput = document.getElementById('inputTemp');
                var flowRateInput = document.getElementById('inputFlowRate');
                var isAutoFlow = document.getElementById('autoCalculateFlow').checked;
                
                phInput.required = isRequired;
                tempInput.required = isRequired;
                
                // Flow Rate is required ONLY if enforcement is ON AND auto-calc is OFF
                flowRateInput.required = isRequired && !isAutoFlow;

                // Update labels to show * for required fields
                document.getElementById('phLabel').innerHTML = 'pH Value' + (isRequired ? ' *' : '');
                document.getElementById('tempLabel').innerHTML = 'Temperature (¬∞C)' + (isRequired ? ' *' : '');
                
                if (isAutoFlow) {
                    document.getElementById('flowRateLabel').innerHTML = 'Flow Rate (m¬≥/hr) (Auto)' + (isRequired ? ' *' : '');
                } else {
                    document.getElementById('flowRateLabel').innerHTML = 'Flow Rate (m¬≥/hr)' + (isRequired ? ' *' : '');
                }

            } catch (error) {
                console.error('Error updating form enforcement:', error);
            }
        }

        function getPHRange() {
            var standard = settings.phStandard || 'A';
            if (standard === 'A') {
                return { min: 6.0, max: 9.0 };
            } else {
                return { min: 5.5, max: 9.0 };
            }
        }

        function checkCompliance(record) {
            var issues = [];
            var status = 'normal';
            
            // Check pH
            if (record.ph !== null && record.ph !== undefined && record.ph !== '') {
                var phRange = getPHRange();
                if (record.ph < phRange.min || record.ph > phRange.max) {
                    issues.push('pH out of range (' + phRange.min + '-' + phRange.max + ')');
                    status = 'critical';
                }
            }
            
            // Check Temperature
            if (record.temperature !== null && record.temperature !== undefined && record.temperature !== '') {
                if (record.temperature > settings.tempThreshold) {
                    issues.push('Temperature exceeds ' + settings.tempThreshold + '¬∞C');
                    if (status !== 'critical') status = 'warning';
                }
            }
            
            // Check Flow Rate
            if (record.flowRate !== null && record.flowRate !== undefined && record.flowRate !== '') {
                if (record.flowRate < settings.flowRateMin || record.flowRate > settings.flowRateMax) {
                    issues.push('Flow rate out of range (' + settings.flowRateMin + '-' + settings.flowRateMax + ')');
                    if (status !== 'critical') status = 'warning';
                }
            }
            
            return { status: status, issues: issues };
        }

        // ========== DATA MANAGEMENT ==========
        function loadRecords() {
            var saved = localStorage.getItem('effluentRecords');
            if (saved) {
                try {
                    records = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading records:', e);
                    records = [];
                }
            }
            filteredRecords = records;
        }

        function saveRecords() {
            try {
                localStorage.setItem('effluentRecords', JSON.stringify(records));
            } catch (e) {
                console.error('Error saving records:', e);
                showAlert('‚ùå Error saving data. Storage may be full.', 'error');
            }
        }

        // ========== VALIDATION (Modified for Enforcement and Styled Alert) ==========
        function validateRecord(record) {
            var errors = [];
            var isEnforced = settings.enforceComplianceData;
            var isAutoFlow = document.getElementById('autoCalculateFlow').checked;
            
            // Required fields
            if (!record.date) errors.push('Date is required');
            if (!record.time) errors.push('Time is required');
            if (!record.type) errors.push('Effluent Type is required');
            if (!record.operator || record.operator.trim() === '') errors.push('Operator Name is required');
            
            // Enforced fields check
            if (isEnforced) {
                if (record.ph === null || record.ph === '') errors.push('pH is required by compliance settings');
                if (record.temperature === null || record.temperature === '') errors.push('Temperature is required by compliance settings');
                
                // Flow Rate Check
                if (!isAutoFlow && (record.flowRate === null || record.flowRate === '')) {
                     errors.push('Flow Rate is required by compliance settings');
                }
                
                // Volume check (required if auto-calc is on)
                if (isAutoFlow && (record.volume === null || record.volume === '')) {
                     errors.push('Volume is required to auto-calculate Flow Rate.');
                }
            }

            // Date validation - check for future dates
            var recordDate = new Date(record.date + 'T' + record.time);
            var now = new Date();
            if (recordDate > now && !editingId) { // Only prompt on new record creation
                var confirmFuture = confirm('‚ö†Ô∏è Warning: This date/time is in the future. Continue anyway?');
                if (!confirmFuture) {
                    errors.push('Future date not confirmed');
                }
            }
            
            // pH validation
            if (record.ph !== null && record.ph !== undefined && record.ph !== '') {
                var ph = parseFloat(record.ph);
                if (isNaN(ph) || ph < 0 || ph > 14) {
                    errors.push('pH must be between 0 and 14');
                }
            }
            
            // Temperature validation
            if (record.temperature !== null && record.temperature !== undefined && record.temperature !== '') {
                var temp = parseFloat(record.temperature);
                if (isNaN(temp)) {
                    errors.push('Temperature must be a valid number');
                }
                if (temp < -50 || temp > 200) {
                    errors.push('Temperature seems unrealistic (should be between -50¬∞C and 200¬∞C)');
                }
            }
            
            // Volume validation
            if (record.volume !== null && record.volume !== undefined && record.volume !== '') {
                var vol = parseFloat(record.volume);
                if (isNaN(vol) || vol < 0) {
                    errors.push('Volume must be a positive number');
                }
            }
            
            // Flow rate validation
            if (record.flowRate !== null && record.flowRate !== undefined && record.flowRate !== '') {
                var flow = parseFloat(record.flowRate);
                if (isNaN(flow) || flow < 0) {
                    errors.push('Flow rate must be a positive number');
                }
            }
            
            // Check for duplicates (same date, time, location)
            if (!editingId) {
                var duplicate = records.find(function(r) {
                    return r.date === record.date && 
                           r.time === record.time && 
                           r.location === record.location;
                });
                
                if (duplicate) {
                    var confirmDuplicate = confirm('‚ö†Ô∏è A record with the same date, time, and location already exists. Add anyway?');
                    if (!confirmDuplicate) {
                        errors.push('Duplicate entry not confirmed');
                    }
                }
            }
            
            return errors;
        }

        // ========== NEW CONSISTENCY CHECK (Original) ==========
        function checkConsistency(newRecord) {
            try {
                // Skip if volume or flowRate are missing, unless enforcement is active
                if (newRecord.volume === null || newRecord.flowRate === null) return true; 

                // Find the previous record by date/time
                var sortedRecords = records.slice().sort(function(a, b) {
                    return (a.date + a.time).localeCompare(b.date + b.time);
                });

                var newRecordDateTime = new Date(newRecord.date + 'T' + newRecord.time);
                var previousRecord = null;
                var previousRecordDateTime = null;

                for (var i = sortedRecords.length - 1; i >= 0; i--) {
                    var r = sortedRecords[i];
                    var rDateTime = new Date(r.date + 'T' + r.time);
                    
                    if (rDateTime < newRecordDateTime && r.id !== newRecord.id) {
                        previousRecord = r;
                        previousRecordDateTime = rDateTime;
                        break;
                    }
                }

                if (!previousRecord || previousRecord.volume === null) return true; // Can't calculate consistency

                var timeDiffMs = newRecordDateTime - previousRecordDateTime;
                var timeDiffHours = timeDiffMs / (1000 * 60 * 60);

                if (timeDiffHours <= 0) return true; // Not a valid interval for calculation

                var calculatedVolume = newRecord.flowRate * timeDiffHours;
                var recordedVolumeDiff = newRecord.volume - previousRecord.volume;
                
                // üü¢ NEW/REVISED: If volume decreased AND compliance enforced, block the save immediately
                if (settings.enforceComplianceData && recordedVolumeDiff < 0) {
                     showAlert('‚ùå Critical Error: Volume decreased since last record. Please correct input or disable Auto-Calc.', 'error');
                     return false; 
                }

                // Allow a tolerance (e.g., 10%)
                var tolerance = 0.10;
                var lowerBound = calculatedVolume * (1 - tolerance);
                var upperBound = calculatedVolume * (1 + tolerance);

                // Check if the recorded volume difference (volume since last record) is within the calculated range
                if (recordedVolumeDiff < lowerBound || recordedVolumeDiff > upperBound) {
                    var message = '‚ö†Ô∏è **Flow Data Consistency Alert**\n\n' +
                                  'Recorded Volume difference since last reading: ' + recordedVolumeDiff.toFixed(2) + ' m¬≥\n' +
                                  'Calculated Volume based on Flow Rate (' + newRecord.flowRate.toFixed(2) + ' m¬≥/hr) and time difference (' + timeDiffHours.toFixed(2) + ' hours): ' + calculatedVolume.toFixed(2) + ' m¬≥\n\n' +
                                  'This deviation is outside the 10% tolerance. Continue anyway?';
                    
                    return confirm(message);
                }

                return true;
            } catch (error) {
                console.error('Error during consistency check:', error);
                // Fail-safe: if the check itself fails, allow the save to proceed
                return true; 
            }
        }


        // ========== SAVE RECORD (Modified for Auto-Calc and Persistence) ==========
        function saveRecord() {
            try {
                var date = document.getElementById('inputDate').value;
                var time = document.getElementById('inputTime').value;
                var type = document.getElementById('inputType').value;
                var customType = document.getElementById('inputCustomType').value;
                var ph = document.getElementById('inputPH').value;
                var temperature = document.getElementById('inputTemp').value;
                var volume = document.getElementById('inputVolume').value;
                var flowRate = document.getElementById('inputFlowRate').value;
                var location = document.getElementById('inputLocation').value;
                var operator = document.getElementById('inputOperator').value;
                var remarks = document.getElementById('inputRemarks').value;

                // Handle "Other" type with custom name
                var finalType = type;
                if (type === 'Other') {
                    if (!customType || customType.trim() === '') {
                        showAlert('‚ùå Please specify the effluent type when selecting "Other"', 'error');
                        return;
                    }
                    finalType = 'Other: ' + customType.trim();
                }

                // üü¢ NEW: Flow Rate Auto-Calculation Logic
                var isAutoFlow = document.getElementById('autoCalculateFlow').checked;
                if (isAutoFlow && volume !== '') {
                    // Find the immediate preceding record with a volume reading
                    var sortedRecords = records.slice().sort(function(a, b) {
                        return (a.date + a.time).localeCompare(b.date + b.time);
                    });
                    
                    var newRecordDateTime = new Date(date + 'T' + time);
                    var previousRecord = null;
                    
                    for (var i = sortedRecords.length - 1; i >= 0; i--) {
                        var r = sortedRecords[i];
                        var rDateTime = new Date(r.date + 'T' + r.time);
                        
                        // Check if the record is truly previous and has a volume reading
                        if (rDateTime < newRecordDateTime && r.volume !== null && r.id !== editingId) {
                            previousRecord = r;
                            break;
                        }
                    }

                    if (previousRecord) {
                        var prevVolume = previousRecord.volume;
                        var prevDateTime = new Date(previousRecord.date + 'T' + previousRecord.time);
                        var timeDiffMs = newRecordDateTime - prevDateTime;
                        var timeDiffHours = timeDiffMs / (1000 * 60 * 60);

                        if (timeDiffHours > 0) {
                            var volumeDiff = parseFloat(volume) - prevVolume;
                            if (volumeDiff >= 0) {
                                var calculatedFlowRate = volumeDiff / timeDiffHours;
                                flowRate = calculatedFlowRate.toFixed(2); // Overwrite flowRate with calculated value
                            } else {
                                // Volume decreased or calculation failed, set flowRate to empty string for validation to catch
                                flowRate = ''; 
                                if (!settings.enforceComplianceData) {
                                    showAlert('‚ö†Ô∏è Volume decreased since last record. Please check input or enter Flow Rate manually.', 'warning');
                                }
                            }
                        } else {
                             // If time is the same or negative, treat as empty flowRate for validation to catch.
                             flowRate = ''; 
                        }
                    } else if (settings.enforceComplianceData) {
                        // If enforcement is on, and we can't calculate (no previous data), treat as empty flowRate for validation
                        flowRate = '';
                    } else {
                        // Not enforced, no previous record, just skip flowRate
                        flowRate = '';
                    }
                }
                // üü¢ END NEW FLOW RATE CALCULATION

                var record = {
                    id: editingId || Date.now(),
                    date: date,
                    time: time,
                    type: finalType,
                    ph: ph !== '' ? parseFloat(ph) : null,
                    temperature: temperature !== '' ? parseFloat(temperature) : null,
                    volume: volume !== '' ? parseFloat(volume) : null,
                    flowRate: flowRate !== '' ? parseFloat(flowRate) : null,
                    location: location,
                    operator: operator,
                    remarks: remarks,
                    createdAt: editingId ? records.find(function(r) { return r.id === editingId; }).createdAt : new Date().toISOString(),
                    editHistory: editingId ? records.find(function(r) { return r.id === editingId; }).editHistory || [] : []
                };

                // 1. Validate
                var errors = validateRecord(record);
                if (errors.length > 0) {
                    // üü¢ REVISED: Use styled alert for validation errors
                    showAlert('‚ùå Validation Errors:\n\n' + errors.join('\n'), 'error');
                    return;
                }

                // 2. Auto-Calculation/Consistency Check 
                if (!checkConsistency(record)) {
                    // If checkConsistency returns false, it already showed an error/confirm dialog.
                    return;
                }

                if (editingId) {
                    var index = records.findIndex(function(r) { return r.id === editingId; });
                    if (index !== -1) {
                        // Add audit trail entry
                        var oldRecord = records[index];
                        var changes = [];
                        if (oldRecord.ph !== record.ph) changes.push('pH: ' + oldRecord.ph + ' ‚Üí ' + record.ph);
                        if (oldRecord.temperature !== record.temperature) changes.push('Temp: ' + oldRecord.temperature + ' ‚Üí ' + record.temperature);
                        if (oldRecord.flowRate !== record.flowRate) changes.push('Flow: ' + oldRecord.flowRate + ' ‚Üí ' + record.flowRate);
                        if (oldRecord.volume !== record.volume) changes.push('Vol: ' + oldRecord.volume + ' ‚Üí ' + record.volume);
                        
                        if (changes.length > 0) {
                            record.editHistory.push({
                                timestamp: new Date().toISOString(),
                                editor: operator,
                                changes: changes.join(', ')
                            });
                        }
                        
                        records[index] = record;
                        showAlert('‚úÖ Record updated successfully!', 'success');
                    }
                    editingId = null;
                    document.getElementById('formTitle').textContent = 'üìù New Reading Entry';
                    document.getElementById('cancelBtn').style.display = 'none';
                } else {
                    records.push(record);
                    showAlert('‚úÖ Record saved successfully!', 'success');
                }

                // üü¢ REVISED: Save Persistent Form Data (Operator/Location)
                localStorage.setItem('lastOperator', operator);
                localStorage.setItem('lastLocation', location);
                // üü¢ END REVISED
                
                saveRecords();
                clearForm();
                updateAll();
            } catch (error) {
                console.error('Error saving record:', error);
                showAlert('‚ùå Error saving record: ' + error.message, 'error');
            }
        }

        // ========== EDIT/DELETE/CLEAR (Modified for Flow Calc Reset) ==========
        function editRecord(id) {
             try {
                var record = records.find(function(r) { return r.id === id; });
                if (!record) {
                    showAlert('‚ùå Record not found', 'error');
                    return;
                }

                editingId = id;

                document.getElementById('inputDate').value = record.date;
                document.getElementById('inputTime').value = record.time;
                
                if (record.type.startsWith('Other: ')) {
                    document.getElementById('inputType').value = 'Other';
                    var customTypeName = record.type.substring(7);
                    document.getElementById('inputCustomType').value = customTypeName;
                    document.getElementById('customTypeContainer').style.display = 'block';
                    document.getElementById('inputCustomType').required = true;
                } else {
                    document.getElementById('inputType').value = record.type;
                    document.getElementById('customTypeContainer').style.display = 'none';
                    document.getElementById('inputCustomType').value = '';
                    document.getElementById('inputCustomType').required = false;
                }
                
                document.getElementById('inputPH').value = record.ph !== null ? record.ph : '';
                document.getElementById('inputTemp').value = record.temperature !== null ? record.temperature : '';
                document.getElementById('inputVolume').value = record.volume !== null ? record.volume : '';
                document.getElementById('inputFlowRate').value = record.flowRate !== null ? record.flowRate : '';
                
                // üü¢ NEW: Clear Auto-Calculation setting when editing a record
                document.getElementById('autoCalculateFlow').checked = false;
                toggleFlowInputMode();
                // üü¢ END NEW

                document.getElementById('inputLocation').value = record.location;
                document.getElementById('inputOperator').value = record.operator;
                document.getElementById('inputRemarks').value = record.remarks;

                document.getElementById('formTitle').textContent = '‚úèÔ∏è Edit Record';
                document.getElementById('cancelBtn').style.display = 'block';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing record:', error);
                showAlert('‚ùå Error loading record for editing', 'error');
            }
        }

        function cancelEdit() {
            editingId = null;
            clearForm();
            document.getElementById('formTitle').textContent = 'üìù New Reading Entry';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('customTypeContainer').style.display = 'none';
            document.getElementById('inputCustomType').required = false;
            
            // üü¢ NEW: Reset flow input mode
            document.getElementById('autoCalculateFlow').checked = false;
            toggleFlowInputMode();
            // üü¢ END NEW
        }

        function deleteRecord(id) {
            if (!confirm('Delete this record?')) return;
            
            try {
                records = records.filter(function(r) { return r.id !== id; });
                saveRecords();
                updateAll();
                showAlert('üóëÔ∏è Record deleted', 'info');
            } catch (error) {
                console.error('Error deleting record:', error);
                showAlert('‚ùå Error deleting record', 'error');
            }
        }

        function clearForm() {
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
            var now = new Date();
            var hours = String(now.getHours()).padStart(2, '0');
            var minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('inputTime').value = hours + ':' + minutes;
            document.getElementById('inputType').value = '';
            document.getElementById('inputCustomType').value = '';
            document.getElementById('customTypeContainer').style.display = 'none';
            document.getElementById('inputCustomType').required = false;
            document.getElementById('inputPH').value = '';
            document.getElementById('inputTemp').value = '';
            document.getElementById('inputVolume').value = '';
            document.getElementById('inputFlowRate').value = '';
            // Operator/Location retained for persistence
            document.getElementById('inputRemarks').value = '';
            
            // üü¢ NEW: Reset flow input mode
            document.getElementById('autoCalculateFlow').checked = false;
            toggleFlowInputMode();
            // üü¢ END NEW
        }

        // ========== STATISTICS (Original) ==========
        function updateStats() {
            try {
                var today = new Date().toISOString().split('T')[0];
                var todayRecords = records.filter(function(r) { return r.date === today; });

                document.getElementById('totalRecords').textContent = records.length;
                document.getElementById('todayRecords').textContent = todayRecords.length;

                var totalVolume = records.reduce(function(sum, r) {
                    return sum + (r.volume || 0);
                }, 0);
                document.getElementById('totalFlow').textContent = totalVolume.toFixed(2) + ' m¬≥';

                var phRecords = records.filter(function(r) { return r.ph !== null && r.ph !== undefined; });
                if (phRecords.length > 0) {
                    var avgPh = phRecords.reduce(function(sum, r) { return sum + r.ph; }, 0) / phRecords.length;
                    document.getElementById('avgPH').textContent = avgPh.toFixed(2);
                } else {
                    document.getElementById('avgPH').textContent = '‚Äî';
                }

                // Average flow rate
                var flowRecords = records.filter(function(r) { return r.flowRate !== null && r.flowRate !== undefined; });
                if (flowRecords.length > 0) {
                    var avgFlow = flowRecords.reduce(function(sum, r) { return sum + r.flowRate; }, 0) / flowRecords.length;
                    document.getElementById('avgFlowRate').textContent = avgFlow.toFixed(2) + ' m¬≥/hr';
                } else {
                    document.getElementById('avgFlowRate').textContent = '‚Äî';
                }

                // Count alerts
                var alertCount = 0;
                records.forEach(function(record) {
                    var compliance = checkCompliance(record);
                    if (compliance.status === 'warning' || compliance.status === 'critical') {
                        alertCount++;
                    }
                });
                document.getElementById('alertCount').textContent = alertCount;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // ========== RENDER RECORDS (Original) ==========
        function renderRecords() {
            try {
                var tbody = document.getElementById('recordsBody');
                
                if (filteredRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-gray-400">No records found</td></tr>';
                    return;
                }

                var html = '';
                filteredRecords.forEach(function(record) {
                    var compliance = checkCompliance(record);
                    var statusBadge = '';
                    var statusIcon = '';
                    
                    if (compliance.status === 'normal') {
                        statusBadge = '<span class="status-badge status-normal">‚úÖ Normal</span>';
                        statusIcon = '';
                    } else if (compliance.status === 'warning') {
                        statusBadge = '<span class="status-badge status-warning warning-indicator">‚ö†Ô∏è Warning</span>';
                        statusIcon = '<div class="text-xs text-yellow-700 mt-1">' + compliance.issues.join(', ') + '</div>';
                    } else if (compliance.status === 'critical') {
                        statusBadge = '<span class="status-badge status-critical warning-indicator">üî¥ Critical</span>';
                        statusIcon = '<div class="text-xs text-red-700 mt-1">' + compliance.issues.join(', ') + '</div>';
                    }

                    html += '<tr class="border-b hover:bg-gray-50">';
                    html += '<td class="px-4 py-3">' + statusBadge + statusIcon + '</td>';
                    html += '<td class="px-4 py-3">' + record.date + '</td>';
                    html += '<td class="px-4 py-3">' + record.time + '</td>';
                    html += '<td class="px-4 py-3">' + record.type + '</td>';
                    html += '<td class="px-4 py-3">' + (record.ph !== null ? record.ph.toFixed(2) : '‚Äî') + '</td>';
                    html += '<td class="px-4 py-3">' + (record.temperature !== null ? record.temperature.toFixed(1) : '‚Äî') + '</td>';
                    html += '<td class="px-4 py-3">' + (record.volume !== null ? record.volume.toFixed(2) : '‚Äî') + '</td>';
                    html += '<td class="px-4 py-3">' + (record.flowRate !== null ? record.flowRate.toFixed(2) : '‚Äî') + '</td>';
                    html += '<td class="px-4 py-3">' + (record.location || '‚Äî') + '</td>';
                    html += '<td class="px-4 py-3">' + record.operator + '</td>';
                    html += '<td class="px-4 py-3">';
                    html += '<button onclick="editRecord(' + record.id + ')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button>';
                    html += '<button onclick="deleteRecord(' + record.id + ')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>';
                    html += '</td>';
                    html += '<td class="px-4 py-3">';
                    if (record.editHistory && record.editHistory.length > 0) {
                        html += '<button onclick="viewEditHistory(' + record.id + ')" class="text-purple-600 hover:text-purple-800 text-xs">';
                        html += '<span class="bg-purple-100 px-2 py-1 rounded">' + record.editHistory.length + ' edit(s)</span>';
                        html += '</button>';
                    } else {
                        html += '<span class="text-gray-400 text-xs">No edits</span>';
                    }
                    html += '</td>';
                    html += '</tr>';
                });

                tbody.innerHTML = html;
                
                document.getElementById('recordCount').textContent = filteredRecords.length;
                document.getElementById('totalCount').textContent = records.length;
            } catch (error) {
                console.error('Error rendering records:', error);
                showAlert('‚ùå Error displaying records', 'error');
            }
        }

        // ========== FILTERS (Original) ==========
        function applyFilters() {
            try {
                var searchText = document.getElementById('searchBox').value.toLowerCase();
                var filterType = document.getElementById('filterType').value;
                var filterOperator = document.getElementById('filterOperator').value;
                var filterStatus = document.getElementById('filterStatus').value;
                var filterDateFrom = document.getElementById('filterDateFrom').value;
                var filterDateTo = document.getElementById('filterDateTo').value;

                filteredRecords = records.filter(function(record) {
                    // Search text
                    if (searchText && !JSON.stringify(record).toLowerCase().includes(searchText)) {
                        return false;
                    }

                    // Type filter
                    if (filterType && record.type !== filterType) {
                        return false;
                    }

                    // Operator filter
                    if (filterOperator && record.operator !== filterOperator) {
                        return false;
                    }

                    // Status filter
                    if (filterStatus) {
                        var compliance = checkCompliance(record);
                        if (compliance.status !== filterStatus) {
                            return false;
                        }
                    }

                    // Date range filter
                    if (filterDateFrom && record.date < filterDateFrom) {
                        return false;
                    }
                    if (filterDateTo && record.date > filterDateTo) {
                        return false;
                    }

                    return true;
                });

                renderRecords();
                updateCharts();
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }

        function applyQuickFilter(filter) {
            try {
                var today = new Date();
                var fromDate = '';
                var toDate = '';

                switch(filter) {
                    case 'today':
                        fromDate = toDate = today.toISOString().split('T')[0];
                        break;
                    case 'yesterday':
                        var yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        fromDate = toDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'last7days':
                        var weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        fromDate = weekAgo.toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'thisMonth':
                        fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'lastMonth':
                        var lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        var lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                        fromDate = lastMonth.toISOString().split('T')[0];
                        toDate = lastMonthEnd.toISOString().split('T')[0];
                        break;
                    case 'all':
                        fromDate = '';
                        toDate = '';
                        break;
                }

                document.getElementById('filterDateFrom').value = fromDate;
                document.getElementById('filterDateTo').value = toDate;
                applyFilters();
            } catch (error) {
                console.error('Error applying quick filter:', error);
            }
        }

        function clearFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterOperator').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            applyFilters();
        }

        function updateOperatorFilter() {
            try {
                var select = document.getElementById('filterOperator');
                var currentValue = select.value;
                
                var operators = {};
                records.forEach(function(r) {
                    if (r.operator) operators[r.operator] = true;
                });

                var html = '<option value="">All Operators</option>';
                Object.keys(operators).sort().forEach(function(op) {
                    html += '<option value="' + op + '">' + op + '</option>';
                });

                select.innerHTML = html;
                select.value = currentValue;
            } catch (error) {
                console.error('Error updating operator filter:', error);
            }
        }

        function updateTypeFilter() {
            try {
                var select = document.getElementById('filterType');
                var currentValue = select.value;
                
                // Collect all unique types from records
                var types = {};
                records.forEach(function(r) {
                    if (r.type) types[r.type] = true;
                });

                // Build dropdown with standard types first, then custom types
                var html = '<option value="">All Types</option>';
                
                // Standard types
                var standardTypes = [
                    'Raw Effluent',
                    'Treated Effluent',
                    'Industrial Wastewater',
                    'Domestic Sewage',
                    'Cooling Water',
                    'Process Water',
                    'Stormwater Runoff'
                ];
                
                standardTypes.forEach(function(type) {
                    if (types[type]) {
                        html += '<option value="' + type + '">' + type + '</option>';
                    }
                });
                
                // Custom types (Other: ...)
                var customTypes = Object.keys(types).filter(function(t) {
                    return t.startsWith('Other: ');
                }).sort();
                
                if (customTypes.length > 0) {
                    html += '<optgroup label="Custom Types">';
                    customTypes.forEach(function(type) {
                        html += '<option value="' + type + '">' + type + '</option>';
                    });
                    html += '</optgroup>';
                }

                select.innerHTML = html;
                select.value = currentValue;
            } catch (error) {
                console.error('Error updating type filter:', error);
            }
        }

        // ========== CHARTS (Multi-Line Daily Trends) ==========
        function updateCharts() {
            try {
                if (filteredRecords.length === 0) {
                    document.getElementById('chartsSection').style.display = 'none';
                    return;
                }

                document.getElementById('chartsSection').style.display = 'block';

                // Destroy existing charts
                Object.values(charts).forEach(function(chart) {
                    if (chart) chart.destroy();
                });
                charts = {};

                // Render new summary charts
                renderStatusPieChart();
                renderHistogram();

                // Group by Type AND Date
                var groupedByDayAndType = {};
                filteredRecords.forEach(function(r) {
                    // Use a combined key: Type_Date
                    var key = r.type + '_' + r.date;
                    if (!groupedByDayAndType[key]) groupedByDayAndType[key] = [];
                    groupedByDayAndType[key].push(r);
                });
                
                // Group by Type to create sections
                var byType = {};
                Object.keys(groupedByDayAndType).forEach(function(key) {
                    var type = key.split('_')[0];
                    if (!byType[type]) byType[type] = [];
                    byType[type] = byType[type].concat(groupedByDayAndType[key]);
                });

                var container = document.getElementById('chartsContainer');
                container.innerHTML = '';

                Object.keys(byType).forEach(function(type) {
                    // Sort all records for this type chronologically for smooth chart rendering
                    var typeRecords = byType[type].sort(function(a, b) {
                        return (a.date + a.time).localeCompare(b.date + b.time);
                    });

                    var safeId = type.replace(/[^a-zA-Z0-9]/g, '_');

                    container.innerHTML += '<div class="mb-8">' +
                        '<h4 class="text-lg font-semibold mb-4 border-b pb-2">' + type + ' - Daily Time Series Analysis</h4>' +
                        '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">' +
                            '<div class="chart-container"><canvas id="phChart_' + safeId + '"></canvas></div>' +
                            '<div class="chart-container"><canvas id="tempChart_' + safeId + '"></canvas></div>' +
                            '<div class="chart-container"><canvas id="flowChart_' + safeId + '"></canvas></div>' +
                        '</div>' +
                    '</div>';

                    // Prepare data as MULTIPLE datasets (one per day)
                    var uniqueDates = [...new Set(typeRecords.map(r => r.date))].sort();

                    var phDatasets = [];
                    var tempDatasets = [];
                    var flowDatasets = [];
                    
                    // Simple color palette (you can expand this if needed)
                    var colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'];
                    
                    // Get all unique TIME labels (max possible labels)
                    var allTimes = [...new Set(typeRecords.map(r => r.time))].sort();
                    var labels = allTimes.map(t => t.substring(0, 5)); // Use HH:MM format

                    uniqueDates.forEach(function(date, index) {
                        var dailyRecords = typeRecords.filter(r => r.date === date);
                        
                        // Map the daily records to the full time scale. If no entry at that time, use null.
                        var phData = labels.map(time => {
                            var record = dailyRecords.find(r => r.time.substring(0, 5) === time);
                            return record ? record.ph : null;
                        });
                        var tempData = labels.map(time => {
                            var record = dailyRecords.find(r => r.time.substring(0, 5) === time);
                            return record ? record.temperature : null;
                        });
                        var flowData = labels.map(time => {
                            var record = dailyRecords.find(r => r.time.substring(0, 5) === time);
                            return record ? record.flowRate : null;
                        });

                        var color = colors[index % colors.length];

                        phDatasets.push({
                            label: date + ' pH',
                            data: phData,
                            borderColor: color,
                            backgroundColor: color + '33', // 20% opacity
                            tension: 0.2,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: true // Connect points over missing data within the day
                        });
                        tempDatasets.push({
                            label: date + ' Temp',
                            data: tempData,
                            borderColor: color,
                            backgroundColor: color + '33',
                            tension: 0.2,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: true
                        });
                        flowDatasets.push({
                            label: date + ' Flow',
                            data: flowData,
                            borderColor: color,
                            backgroundColor: color + '33',
                            tension: 0.2,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: true
                        });
                    });
                    
                    // --- 1. pH Chart ---
                    var phRange = getPHRange();
                    if (charts['ph_' + safeId]) charts['ph_' + safeId].destroy();

                    charts['ph_' + safeId] = new Chart(document.getElementById('phChart_' + safeId), {
                        type: 'line',
                        data: {
                            labels: labels, // Time of day
                            datasets: phDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'pH Trend by Day' },
                                legend: { 
                                    display: true,
                                    position: 'bottom'
                                },
                                annotation: {
                                    annotations: {
                                        minLine: {
                                            type: 'line',
                                            yMin: phRange.min,
                                            yMax: phRange.min,
                                            borderColor: 'rgb(234, 179, 8)',
                                            borderWidth: 2,
                                            borderDash: [5, 5],
                                            label: { content: 'Min: ' + phRange.min, enabled: true }
                                        },
                                        maxLine: {
                                            type: 'line',
                                            yMin: phRange.max,
                                            yMax: phRange.max,
                                            borderColor: 'rgb(234, 179, 8)',
                                            borderWidth: 2,
                                            borderDash: [5, 5],
                                            label: { content: 'Max: ' + phRange.max, enabled: true }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    min: 0,
                                    max: 14,
                                    title: { display: true, text: 'pH Value' }
                                },
                                x: {
                                    title: { display: true, text: 'Time of Day' }
                                }
                            }
                        }
                    });

                    // --- 2. Temperature Chart ---
                    if (charts['temp_' + safeId]) charts['temp_' + safeId].destroy();
                    charts['temp_' + safeId] = new Chart(document.getElementById('tempChart_' + safeId), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: tempDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Temperature Trend by Day' },
                                legend: { display: true, position: 'bottom' }
                            },
                            scales: {
                                y: {
                                    title: { display: true, text: 'Temperature (¬∞C)' },
                                    ticks: { callback: function(value) { return value.toFixed(1) + '¬∞C'; } }
                                },
                                x: {
                                    title: { display: true, text: 'Time of Day' }
                                }
                            }
                        }
                    });

                    // --- 3. Flow Rate Chart ---
                    if (charts['flow_' + safeId]) charts['flow_' + safeId].destroy();
                    charts['flow_' + safeId] = new Chart(document.getElementById('flowChart_' + safeId), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: flowDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Flow Rate Trend by Day' },
                                legend: { display: true, position: 'bottom' }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    title: { display: true, text: 'Flow Rate (m¬≥/hr)' },
                                    ticks: { callback: function(value) { return value.toFixed(2); } }
                                },
                                x: {
                                    title: { display: true, text: 'Time of Day' }
                                }
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error updating charts:', error);
                showAlert('‚ùå Error rendering charts.', 'error');
            }
        }
        
        // ========== NEW CHART FUNCTION: Status Pie Chart (Original) ==========
        function renderStatusPieChart() {
            try {
                var statusCounts = { normal: 0, warning: 0, critical: 0 };
                
                filteredRecords.forEach(function(r) {
                    var compliance = checkCompliance(r);
                    statusCounts[compliance.status]++;
                });

                var total = filteredRecords.length;
                var data = [
                    statusCounts.normal,
                    statusCounts.warning,
                    statusCounts.critical
                ];

                if (charts['statusPieChart']) charts['statusPieChart'].destroy();
                
                charts['statusPieChart'] = new Chart(document.getElementById('statusPieChart'), {
                    type: 'pie',
                    data: {
                        labels: [
                            'Normal (' + ((statusCounts.normal / total) * 100).toFixed(1) + '%)', 
                            'Warning (' + ((statusCounts.warning / total) * 100).toFixed(1) + '%)', 
                            'Critical (' + ((statusCounts.critical / total) * 100).toFixed(1) + '%)'
                        ],
                        datasets: [{
                            data: data,
                            backgroundColor: ['rgb(34, 197, 94)', 'rgb(251, 191, 36)', 'rgb(239, 68, 68)'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Compliance Status Distribution (Filtered Records)',
                                font: { size: 16 }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error rendering status pie chart:', error);
            }
        }
        
        // ========== NEW CHART FUNCTION: Histogram (for PH and Temp) (Original) ==========
        function renderHistogram() {
            try {
                var phValues = filteredRecords.filter(function(r) { return r.ph !== null; }).map(function(r) { return r.ph; });
                var tempValues = filteredRecords.filter(function(r) { return r.temperature !== null; }).map(function(r) { return r.temperature; });

                if (phValues.length === 0 && tempValues.length === 0) {
                    // Placeholder or clear chart if no data
                    return;
                }

                // Function to calculate histogram bins
                function calculateHistogram(data, minVal, maxVal, binCount) {
                    var range = maxVal - minVal;
                    var binSize = range / binCount;
                    var bins = Array(binCount).fill(0);
                    var labels = [];
                    
                    for (var i = 0; i < binCount; i++) {
                        var lower = minVal + i * binSize;
                        var upper = minVal + (i + 1) * binSize;
                        labels.push(lower.toFixed(1) + '-' + upper.toFixed(1));
                    }
                    
                    data.forEach(function(val) {
                        var binIndex = Math.floor((val - minVal) / binSize);
                        if (binIndex >= 0 && binIndex < binCount) {
                            bins[binIndex]++;
                        } else if (binIndex === binCount && val === maxVal) {
                             bins[binCount - 1]++;
                        }
                    });
                    
                    return { bins: bins, labels: labels };
                }

                // PH Histogram
                var phHistData = calculateHistogram(phValues, 5, 10, 10);
                if (charts['phHistogramChart']) charts['phHistogramChart'].destroy();

                charts['phHistogramChart'] = new Chart(document.getElementById('phHistogramChart'), {
                    type: 'bar',
                    data: {
                        labels: phHistData.labels,
                        datasets: [{
                            label: 'Frequency',
                            data: phHistData.bins,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'pH Value Distribution (Range 5.0 - 10.0)',
                                font: { size: 16 }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Number of Records' } },
                            x: { title: { display: true, text: 'pH Bins' } }
                        }
                    }
                });

            } catch (error) {
                console.error('Error rendering histogram:', error);
            }
        }


        // ========== EXPORT PDF (Original) ==========
        function exportPDF() {
            try {
                if (records.length === 0) {
                    showAlert('No records to export', 'info');
                    return;
                }
                
                var buttons = document.querySelectorAll('button');
                buttons.forEach(function(btn) { btn.classList.add('no-print'); });
                
                window.print();
                
                setTimeout(function() {
                    buttons.forEach(function(btn) { btn.classList.remove('no-print'); });
                }, 100);
                
                showAlert('‚úÖ PDF export dialog opened', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showAlert('‚ùå Error exporting PDF', 'error');
            }
        }

        // ========== IMPORT/EXPORT/BACKUP/RESTORE/DELETE ALL (Modified Export Excel & Analytics Units) ==========
        
        function updateAdvancedAnalytics() {
            try {
                // pH Statistics (No unit needed)
                var phValues = records.filter(function(r) { return r.ph !== null; }).map(function(r) { return r.ph; });
                if (phValues.length > 0) {
                    document.getElementById('phMin').textContent = Math.min(...phValues).toFixed(2);
                    document.getElementById('phMax').textContent = Math.max(...phValues).toFixed(2);
                    document.getElementById('phMedian').textContent = calculateMedian(phValues).toFixed(2);
                    document.getElementById('phStdDev').textContent = calculateStdDev(phValues).toFixed(2);
                } else {
                    document.getElementById('phMin').textContent = '‚Äî';
                    document.getElementById('phMax').textContent = '‚Äî';
                    document.getElementById('phMedian').textContent = '‚Äî';
                    document.getElementById('phStdDev').textContent = '‚Äî';
                }

                // Temperature Statistics
                var tempValues = records.filter(function(r) { return r.temperature !== null; }).map(function(r) { return r.temperature; });
                if (tempValues.length > 0) {
                    // üü¢ REVISED: Add Units
                    document.getElementById('tempMin').textContent = Math.min(...tempValues).toFixed(1) + '¬∞C';
                    document.getElementById('tempMax').textContent = Math.max(...tempValues).toFixed(1) + '¬∞C';
                    document.getElementById('tempMedian').textContent = calculateMedian(tempValues).toFixed(1) + '¬∞C';
                    document.getElementById('tempStdDev').textContent = calculateStdDev(tempValues).toFixed(1) + '¬∞C';
                } else {
                    document.getElementById('tempMin').textContent = '‚Äî';
                    document.getElementById('tempMax').textContent = '‚Äî';
                    document.getElementById('tempMedian').textContent = '‚Äî';
                    document.getElementById('tempStdDev').textContent = '‚Äî';
                }

                // Flow Rate Statistics
                var flowValues = records.filter(function(r) { return r.flowRate !== null; }).map(function(r) { return r.flowRate; });
                if (flowValues.length > 0) {
                    // üü¢ REVISED: Add Units
                    document.getElementById('flowMin').textContent = Math.min(...flowValues).toFixed(2) + ' m¬≥/hr';
                    document.getElementById('flowMax').textContent = Math.max(...flowValues).toFixed(2) + ' m¬≥/hr';
                    document.getElementById('flowMedian').textContent = calculateMedian(flowValues).toFixed(2) + ' m¬≥/hr';
                    document.getElementById('flowStdDev').textContent = calculateStdDev(flowValues).toFixed(2) + ' m¬≥/hr';
                } else {
                    document.getElementById('flowMin').textContent = '‚Äî';
                    document.getElementById('flowMax').textContent = '‚Äî';
                    document.getElementById('flowMedian').textContent = '‚Äî';
                    document.getElementById('flowStdDev').textContent = '‚Äî';
                }
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        function calculateMedian(values) {
            if (values.length === 0) return 0;
            var sorted = values.slice().sort(function(a, b) { return a - b; });
            var mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
        }

        function calculateStdDev(values) {
            if (values.length === 0) return 0;
            var avg = values.reduce(function(sum, val) { return sum + val; }, 0) / values.length;
            var squareDiffs = values.map(function(val) { return Math.pow(val - avg, 2); });
            var avgSquareDiff = squareDiffs.reduce(function(sum, val) { return sum + val; }, 0) / values.length;
            return Math.sqrt(avgSquareDiff);
        }

        function viewEditHistory(id) {
            var record = records.find(function(r) { return r.id === id; });
            if (!record) return;
            
            var history = record.editHistory || [];
            if (history.length === 0) {
                showAlert('üìã No edit history for this record', 'info');
                return;
            }
            
            var html = 'üìã Edit History:\n\n';
            history.forEach(function(edit, index) {
                var date = new Date(edit.timestamp).toLocaleString();
                html += (index + 1) + '. ' + date + ' by ' + edit.editor + '\n';
                html += '   Changes: ' + edit.changes + '\n\n';
            });
            
            // üü¢ REVISED: Use styled alert for history view
            showAlert(html, 'info'); 
        }

        function exportExcel() {
             try {
                if (records.length === 0) {
                    showAlert('No records to export', 'info');
                    return;
                }

                var data = records.map(function(r) {
                    var compliance = checkCompliance(r);
                    return {
                        'Date': r.date,
                        'Time': r.time,
                        'Type': r.type,
                        'pH': r.ph !== null ? r.ph : '',
                        'Temperature (¬∞C)': r.temperature !== null ? r.temperature : '',
                        'Volume (m¬≥)': r.volume !== null ? r.volume : '',
                        'Flow Rate (m¬≥/hr)': r.flowRate !== null ? r.flowRate : '',
                        'Location': r.location || '',
                        'Operator': r.operator,
                        'Remarks': r.remarks || '',
                        'Status': compliance.status.toUpperCase(),
                        'Compliance Issues': compliance.issues.join('; ')
                    };
                });

                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.json_to_sheet(data);

                ws['!cols'] = [
                    {wch: 12}, // Date
                    {wch: 8},  // Time
                    {wch: 20}, // Type
                    {wch: 8},  // pH
                    {wch: 15}, // Temperature
                    {wch: 12}, // Volume
                    {wch: 15}, // Flow Rate
                    {wch: 15}, // Location
                    {wch: 15}, // Operator
                    {wch: 30}, // Remarks
                    {wch: 12}, // Status
                    {wch: 40}  // Issues
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Effluent Records");

                var summary = [
                    {Metric: 'Total Records', Value: records.length},
                    {Metric: 'Date Range', Value: records.length > 0 ? records[0].date + ' to ' + records[records.length-1].date : 'N/A'},
                    {Metric: 'Total Volume (m¬≥)', Value: records.reduce(function(sum, r) { return sum + (r.volume || 0); }, 0).toFixed(2)},
                    {Metric: 'Average pH', Value: (function() {
                        var phRecords = records.filter(function(r) { return r.ph !== null; });
                        return phRecords.length > 0 ? (phRecords.reduce(function(sum, r) { return sum + r.ph; }, 0) / phRecords.length).toFixed(2) : 'N/A';
                    })()},
                    {Metric: 'pH Standard', Value: settings.phStandard === 'A' ? 'Standard A (6.0-9.0)' : 'Standard B (5.5-9.0)'},
                    {Metric: 'Export Date', Value: new Date().toISOString()}
                ];
                var ws_summary = XLSX.utils.json_to_sheet(summary);
                XLSX.utils.book_append_sheet(wb, ws_summary, "Summary");

                // üü¢ REVISED: Cleaned Export Filename
                var today = new Date();
                var dateString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                XLSX.writeFile(wb, 'Effluent_Records_' + dateString + '.xlsx');
                // üü¢ END REVISED
                
                showAlert('‚úÖ Exported ' + records.length + ' records to Excel', 'success');
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showAlert('‚ùå Error exporting Excel. Make sure the SheetJS library is loaded.', 'error');
            }
        }

        function importData(event) {
            try {
                var file = event.target.files[0];
                if (!file) return;
                
                var fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv')) {
                    importCSV(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    importExcel(file);
                } else {
                    showAlert('‚ùå Unsupported file format. Please use CSV or Excel files.', 'error');
                }
                
                event.target.value = '';
            } catch (error) {
                console.error('Error importing data:', error);
                showAlert('‚ùå Error importing file', 'error');
            }
        }

        function importCSV(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var lines = e.target.result.split('\n');
                    var headers = lines[0].split(',').map(function(h) { return h.trim(); });
                    
                    var imported = 0;
                    var skipped = 0;
                    
                    for (var i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        var values = lines[i].split(',');
                        if (values.length < 3) continue;
                        
                        var record = {
                            id: Date.now() + i,
                            date: values[0] || '',
                            time: values[1] || '',
                            type: values[2] ? values[2].replace(/"/g, '') : '',
                            ph: values[3] ? parseFloat(values[3]) : null,
                            temperature: values[4] ? parseFloat(values[4]) : null,
                            volume: values[5] ? parseFloat(values[5]) : null,
                            flowRate: values[6] ? parseFloat(values[6]) : null,
                            location: values[7] ? values[7].replace(/"/g, '') : '',
                            operator: values[8] ? values[8].replace(/"/g, '') : '',
                            remarks: values[9] ? values[9].replace(/"/g, '') : '',
                            createdAt: new Date().toISOString(),
                            editHistory: []
                        };
                        
                        if (record.date && record.time && record.type && record.operator) {
                            records.push(record);
                            imported++;
                        } else {
                            skipped++;
                        }
                    }
                    
                    if (imported > 0) {
                        saveRecords();
                        updateAll();
                        showAlert('‚úÖ Imported ' + imported + ' records' + (skipped > 0 ? ' (' + skipped + ' skipped)' : ''), 'success');
                    } else {
                        showAlert('‚ùå No valid records found in file', 'error');
                    }
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    showAlert('‚ùå Error parsing CSV file', 'error');
                }
            };
            reader.readAsText(file);
        }

        function importExcel(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    var jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    var imported = 0;
                    var skipped = 0;
                    
                    jsonData.forEach(function(row, index) {
                        var record = {
                            id: Date.now() + index,
                            date: row['Date'] || row['date'] || '',
                            time: row['Time'] || row['time'] || '',
                            type: row['Type'] || row['type'] || '',
                            ph: row['pH'] || row['ph'] || null,
                            temperature: row['Temperature (¬∞C)'] || row['Temperature'] || null,
                            volume: row['Volume (m¬≥)'] || row['Volume'] || null,
                            flowRate: row['Flow Rate (m¬≥/hr)'] || row['Flow Rate'] || null,
                            location: row['Location'] || row['location'] || '',
                            operator: row['Operator'] || row['operator'] || '',
                            remarks: row['Remarks'] || row['remarks'] || '',
                            createdAt: new Date().toISOString(),
                            editHistory: []
                        };
                        
                        if (record.date && record.time && record.type && record.operator) {
                            records.push(record);
                            imported++;
                        } else {
                            skipped++;
                        }
                    });
                    
                    if (imported > 0) {
                        saveRecords();
                        updateAll();
                        showAlert('‚úÖ Imported ' + imported + ' records' + (skipped > 0 ? ' (' + skipped + ' skipped)' : ''), 'success');
                    } else {
                        showAlert('‚ùå No valid records found in file', 'error');
                    }
                } catch (error) {
                    console.error('Error parsing Excel:', error);
                    showAlert('‚ùå Error parsing Excel file', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function backupData() {
            try {
                var backup = {
                    records: records,
                    settings: settings,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                var blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'Effluent_Backup_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Backup downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('‚ùå Error creating backup', 'error');
            }
        }

        function restoreData(event) {
            try {
                var file = event.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var backup = JSON.parse(e.target.result);
                        
                        if (!backup.records || !Array.isArray(backup.records)) {
                            showAlert('‚ùå Invalid backup file format!', 'error');
                            return;
                        }
                        
                        // Retain native confirm for critical data restoration
                        if (confirm('Restore ' + backup.records.length + ' records? This will overwrite current data!')) {
                            records = backup.records || [];
                            if (backup.settings) {
                                settings = Object.assign(settings, backup.settings);
                                document.getElementById('phStandard').value = settings.phStandard || 'A';
                                document.getElementById('tempThreshold').value = settings.tempThreshold || 40;
                                document.getElementById('flowRateMin').value = settings.flowRateMin || 0;
                                document.getElementById('flowRateMax').value = settings.flowRateMax || 100;
                                document.getElementById('enforceComplianceData').checked = settings.enforceComplianceData || false;
                                saveSettings();
                            }
                            saveRecords();
                            updateAll();
                            showAlert('‚úÖ Data restored successfully!', 'success');
                        }
                    } catch (err) {
                        console.error('Error parsing backup:', err);
                        showAlert('‚ùå Invalid backup file!', 'error');
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            } catch (error) {
                console.error('Error restoring data:', error);
                showAlert('‚ùå Error restoring data', 'error');
            }
        }

        function deleteAllData() {
            try {
                // Retain native confirm for critical data deletion
                if (!confirm('‚ö†Ô∏è DELETE ALL DATA? This cannot be undone!')) return;
                if (!confirm('Are you ABSOLUTELY SURE? All records will be permanently deleted!')) return;
                
                records = [];
                filteredRecords = [];
                saveRecords();
                updateAll();
                showAlert('üóëÔ∏è All data deleted', 'info');
            } catch (error) {
                console.error('Error deleting data:', error);
                showAlert('‚ùå Error deleting data', 'error');
            }
        }

        function toggleDarkMode() {
            try {
                document.body.classList.toggle('dark-mode');
                var isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDark);
                document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            } catch (error) {
                console.error('Error toggling dark mode:', error);
            }
        }

        function showAlert(message, type) {
            try {
                var container = document.getElementById('alertContainer');
                var alertDiv = document.createElement('div');
                
                var bgColor = type === 'success' ? 'bg-green-500' : 
                             type === 'error' ? 'bg-red-500' : 
                             type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
                
                alertDiv.className = 'alert-banner ' + bgColor + ' text-white px-6 py-4 shadow-lg';
                // üü¢ REVISED: Added style for multi-line support
                alertDiv.innerHTML = '<div class="container mx-auto" style="white-space: pre-wrap;">' + message + '</div>';
                // üü¢ END REVISED
                
                container.appendChild(alertDiv);
                
                setTimeout(function() {
                    alertDiv.style.opacity = '0';
                    setTimeout(function() {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 500);
                }, 3000);
            } catch (error) {
                console.error('Error showing alert:', error);
            }
        }
        
        function toggleAnalytics() {
            var content = document.getElementById('analyticsContent');
            var toggle = document.getElementById('analyticsToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'Hide Details';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Show Details';
            }
        }
    </script>

</body>
</html>